# ChildWatch - Android Monitoring Application

ChildWatch - это Android приложение для мониторинга местоположения и записи аудио, предназначенное для обеспечения безопасности детей. Приложение работает как foreground service с постоянным уведомлением и отправляет данные на сервер.

## ⚖️ ВАЖНЫЕ ЮРИДИЧЕСКИЕ И ЭТИЧЕСКИЕ АСПЕКТЫ

**ВНИМАНИЕ**: Это приложение предназначено ТОЛЬКО для законного использования с явного согласия отслеживаемого лица.

### Допустимые сценарии использования:
- ✅ Родительский контроль для несовершеннолетних детей
- ✅ Безопасность пожилых родственников (с их согласия)
- ✅ Корпоративные устройства с письменным согласием сотрудников
- ✅ Поиск потерянных/украденных устройств (собственных)

### Недопустимое использование:
- ❌ Слежка за взрослыми без их согласия
- ❌ Шпионаж за супругами/партнерами
- ❌ Любое использование без явного согласия отслеживаемого лица
- ❌ Коммерческое использование без соответствующих лицензий

### Текст согласия для установки на устройство ребенка:

```
"Данное приложение будет отслеживать местоположение этого устройства и периодически записывать звук вокруг для обеспечения безопасности. Все данные передаются только родителям/опекунам и используются исключительно в целях безопасности. Мониторинг можно отключить в любое время через настройки приложения. Используя это приложение, вы соглашаетесь с данными условиями."
```

## 🏗️ Архитектура приложения

### Основные компоненты:

1. **MainActivity** - Главный экран с onboarding и управлением
2. **MonitorService** - Foreground сервис для непрерывного мониторинга
3. **LocationManager** - Работа с GPS через Google Play Services
4. **AudioRecorder** - Запись аудио фрагментов
5. **NetworkClient** - HTTP клиент для отправки данных
6. **PermissionHelper** - Управление разрешениями
7. **BootReceiver** - Автозапуск после перезагрузки

### Функционал:

- 📍 **Отслеживание геолокации** - каждые 30 секунд (настраивается)
- 🎤 **Запись аудио** - по команде, длительность настраивается
- 📤 **Отправка данных** - HTTPS на сервер или Firebase Storage
- 🔔 **Foreground уведомления** - показывает активность мониторинга
- 🔐 **Управление разрешениями** - запрос всех необходимых разрешений
- 📱 **FCM команды** - удаленное управление (requestLocationNow, startAudioCapture)

## 📋 Требования

### Android:
- **minSdk**: 26 (Android 8.0)
- **targetSdk**: 34 (Android 14)
- **Разрешения**: GPS, микрофон, сеть, foreground service

### Сервер:
- Node.js 16+
- Порт 3000 (по умолчанию)
- ngrok для тестирования

## 🚀 Установка и сборка

### 1. Клонирование и подготовка

```bash
# Если проект в git репозитории
git clone <repository-url>
cd ChildWatch

# Или создание с нуля (уже создано)
# mkdir ChildWatch && cd ChildWatch
```

### 2. Сборка Android приложения

```bash
# Сборка debug версии
./gradlew assembleDebug

# Результат: app/build/outputs/apk/debug/app-debug.apk
```

### 3. Установка на устройство

```bash
# Установка через ADB
adb install -r app/build/outputs/apk/debug/app-debug.apk

# Запуск приложения
adb shell am start -n ru.example.childwatch/.MainActivity
```

### 4. Выдача разрешений через ADB

```bash
# Основные разрешения
adb shell pm grant ru.example.childwatch android.permission.ACCESS_FINE_LOCATION
adb shell pm grant ru.example.childwatch android.permission.ACCESS_COARSE_LOCATION
adb shell pm grant ru.example.childwatch android.permission.RECORD_AUDIO

# Фоновая геолокация (Android 10+)
# ВНИМАНИЕ: Может не работать через ADB на некоторых устройствах
adb shell pm grant ru.example.childwatch android.permission.ACCESS_BACKGROUND_LOCATION
```

**Если фоновая геолокация не работает через ADB:**

1. Откройте Настройки → Приложения → ChildWatch → Разрешения
2. Нажмите на "Местоположение"
3. Выберите "Разрешить все время"

### 5. Настройка и запуск сервера

```bash
# Переход в каталог сервера
cd server

# Установка зависимостей
npm install

# Запуск сервера
npm start

# Для разработки с автоперезапуском
npm run dev
```

### 6. Настройка ngrok для тестирования

```bash
# Установка ngrok (если не установлен)
# Скачать с https://ngrok.com/download

# Запуск туннеля для порта 3000
ngrok http 3000

# Скопируйте HTTPS URL (например: https://abc123.ngrok.io)
# Вставьте в настройки приложения как Server URL
```

## ⚙️ Конфигурация

### Настройки приложения:

1. **Интервал отправки локации** - по умолчанию 30 секунд
2. **Длительность аудио** - по умолчанию 20 секунд  
3. **URL сервера** - замените на ваш ngrok URL

### Изменение endpoint в приложении:

1. Запустите приложение
2. Дайте согласие на мониторинг
3. В разделе "Настройки" измените "URL сервера"
4. Введите ваш ngrok URL: `https://your-id.ngrok.io`

## 🧪 Тестирование

### Проверка работы приложения:

1. **Установка и запуск**:
   ```bash
   ./gradlew assembleDebug
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   adb shell am start -n ru.example.childwatch/.MainActivity
   ```

2. **Проверка разрешений**:
   - Откройте приложение
   - Нажмите "Разрешаю" в экране согласия
   - Предоставьте все запрашиваемые разрешения

3. **Запуск мониторинга**:
   - Включите переключатель "Активировать мониторинг"
   - Нажмите "Начать мониторинг"
   - Проверьте появление уведомления

4. **Проверка отправки данных**:
   - Запустите сервер: `cd server && npm start`
   - Запустите ngrok: `ngrok http 3000`
   - Обновите URL в приложении
   - Проверьте логи сервера на наличие POST запросов

### Проверка логов:

```bash
# Логи Android приложения
adb logcat | grep ChildWatch

# Логи сервера
tail -f server/server.log

# Или просто смотрите консоль сервера
```

### Тестирование команд FCM (эмуляция):

```bash
# Запрос текущей локации
adb shell am start-foreground-service \
  -n ru.example.childwatch/.service.MonitorService \
  -a request_location

# Запись аудио на 15 секунд
adb shell am start-foreground-service \
  -n ru.example.childwatch/.service.MonitorService \
  -a start_audio_capture \
  --ei audio_duration 15
```

## 📁 Структура проекта

```
ChildWatch/
├── app/
│   ├── build.gradle                    # Зависимости и конфигурация
│   └── src/main/
│       ├── AndroidManifest.xml         # Разрешения и компоненты
│       ├── java/ru/example/childwatch/
│       │   ├── MainActivity.kt          # Главный экран
│       │   ├── service/
│       │   │   └── MonitorService.kt    # Foreground сервис
│       │   ├── location/
│       │   │   └── LocationManager.kt   # GPS менеджер
│       │   ├── audio/
│       │   │   └── AudioRecorder.kt     # Запись аудио
│       │   ├── network/
│       │   │   └── NetworkClient.kt     # HTTP клиент
│       │   ├── utils/
│       │   │   └── PermissionHelper.kt  # Помощник разрешений
│       │   └── receiver/
│       │       └── BootReceiver.kt      # Автозапуск
│       └── res/                         # Ресурсы (layouts, strings, etc.)
├── server/
│   ├── package.json                     # Node.js зависимости
│   ├── index.js                         # Express сервер
│   └── uploads/                         # Загруженные файлы
├── build.gradle                         # Корневая конфигурация
├── settings.gradle                      # Настройки проекта
└── README.md                            # Этот файл
```

## 🔧 Отладка и решение проблем

### Частые проблемы:

1. **Разрешения не предоставлены**:
   - Проверьте через ADB: `adb shell dumpsys package ru.example.childwatch | grep permission`
   - Предоставьте вручную через настройки устройства

2. **Фоновая геолокация не работает**:
   - Android 10+: обязательно "Разрешить все время" в настройках
   - Проверьте оптимизацию батареи: отключите для ChildWatch

3. **Аудио не записывается на Android 14+**:
   - Убедитесь, что foreground сервис активен
   - Проверьте уведомление - должно показывать "Запись аудио..."

4. **Сервер не получает данные**:
   - Проверьте URL в настройках приложения
   - Убедитесь, что ngrok активен
   - Проверьте логи сервера

### Команды для отладки:

```bash
# Проверка статуса сервиса
adb shell dumpsys activity services ru.example.childwatch

# Проверка уведомлений
adb shell dumpsys notification

# Принудительная остановка приложения
adb shell am force-stop ru.example.childwatch

# Очистка данных приложения
adb shell pm clear ru.example.childwatch
```

## 🔒 Безопасность

### Реализованные меры:

- ✅ HTTPS-only для всех сетевых запросов
- ✅ Локальное хранение настроек в SharedPreferences
- ✅ Автоудаление старых аудиофайлов
- ✅ Явное согласие пользователя
- ✅ Видимые уведомления о мониторинге

### Рекомендации для продакшена:

- 🔐 Использовать Firebase Authentication
- 🔐 Шифровать передаваемые данные
- 🔐 Реализовать device fingerprinting
- 🔐 Добавить server-side валидацию
- 🔐 Использовать сертификат pinning

## 🚀 Развертывание

### Для продакшена:

1. **Замените тестовый сервер** на полноценный backend
2. **Настройте Firebase** (FCM, Storage, Firestore)
3. **Добавьте аутентификацию** и авторизацию
4. **Настройте HTTPS сертификаты**
5. **Реализуйте web-панель** для родителей
6. **Добавьте уведомления** и алерты

### TODO для продакшена:

- [ ] Firebase integration (FCM, Storage)
- [ ] Web dashboard для родителей
- [ ] Push уведомления для алертов
- [ ] Фото захват по команде
- [ ] Геофенсинг (уведомления о входе/выходе из зоны)
- [ ] История перемещений
- [ ] Настройки конфиденциальности
- [ ] Многопользовательский режим

## 📞 Поддержка

Для вопросов и проблем:

1. Проверьте логи: `adb logcat | grep ChildWatch`
2. Убедитесь в правильности настроек сервера
3. Проверьте все разрешения в настройках Android
4. Отключите оптимизацию батареи для приложения

---

**ПОМНИТЕ**: Используйте это приложение только в законных целях с явного согласия всех участников. Разработчики не несут ответственности за неправомерное использование.